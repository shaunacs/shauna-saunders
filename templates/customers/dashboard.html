{% extends 'customers/base_customers.html' %}

{% block title %}Dashboard - Customer Portal{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>Welcome, {{ customer.name }}!</h1>
        <p class="dashboard-subtitle">Manage your projects and payments</p>
    </div>

    {% if unsigned_agreements %}
    <div class="agreement-warning-banner">
        <span class="warning-icon">&#9888;</span>
        <div class="warning-content">
            <strong>Action Required:</strong> You have {{ unsigned_agreements|length }} agreement(s) waiting for your signature.
            <a href="{{ url_for('customers.agreements') }}">Review and sign now</a>
        </div>
    </div>
    {% endif %}

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Active Projects</div>
            <div class="stat-value">{{ projects|length }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Paid</div>
            <div class="stat-value">${{ "%.2f"|format(total_paid) }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Outstanding Balance</div>
            <div class="stat-value">${{ "%.2f"|format(outstanding_balance) }}</div>
        </div>
    </div>

    {% if payment_links %}
    <section class="section">
        <h2>Payment Links</h2>
        <p class="section-subtitle">Your project manager has created payment links for you</p>

        <div class="payment-links-list">
            {% for link in payment_links %}
            <div class="payment-link-card">
                <div class="payment-link-info">
                    <h3>${{ "%.2f"|format(link.amount) }}</h3>
                    <p>{{ link.description or 'Project Payment' }}</p>
                    {% if link.expires_at %}
                    <p class="expires">Expires: {{ link.expires_at[:10] }}</p>
                    {% endif %}
                </div>
                <a href="{{ link.stripe_checkout_url }}" class="btn btn-primary">Pay Now</a>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="section">
        <h2>Your Projects</h2>

        {% if projects %}
        <div class="projects-grid">
            {% for project in projects %}
            <div class="project-card">
                <div class="project-header">
                    <h3>{{ project.project_name }}</h3>
                    <span class="project-status status-{{ project.status }}">{{ project.status|title }}</span>
                </div>

                <div class="project-body">
                    <p class="project-type">{{ project.project_type|replace('_', ' ')|title }}</p>

                    {% if project.is_subscription %}
                        <div class="subscription-info" style="padding:1rem; background:var(--bg-dark); border-radius:8px; margin:1rem 0; border:1px solid var(--border-color);">
                            <div class="financial-item" style="margin-bottom:0.5rem;">
                                <span class="label">Monthly Rate:</span>
                                <span class="value">${{ "%.2f"|format(project.total_amount) }}/month</span>
                            </div>
                            <div class="financial-item">
                                <span class="label">Status:</span>
                                <span class="value">
                                    {% if project.subscription_status == 'active' %}
                                        <span style="color:#10b981;">Active</span>
                                    {% elif project.subscription_status == 'cancel_pending' %}
                                        <span style="color:#f59e0b;">Cancelling</span>
                                    {% elif project.subscription_status == 'pending' %}
                                        <span style="color:#f59e0b;">Pending</span>
                                    {% elif project.subscription_status == 'cancelled' %}
                                        <span style="color:#ef4444;">Cancelled</span>
                                    {% else %}
                                        <span style="color:#f59e0b;">Not Subscribed</span>
                                    {% endif %}
                                </span>
                            </div>
                            {% if project.next_payment_date and project.subscription_status in ['active', 'cancel_pending'] %}
                            <div class="financial-item">
                                <span class="label">Next Payment:</span>
                                <span class="value">{{ project.next_payment_date|format_date }}</span>
                            </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ project.completion_percentage }}%"></div>
                        </div>
                        <p class="progress-label">{{ project.completion_percentage }}% Complete</p>

                        <div class="project-financials">
                            <div class="financial-item">
                                <span class="label">Total:</span>
                                <span class="value">${{ "%.2f"|format(project.total_amount) }}</span>
                            </div>
                            <div class="financial-item">
                                <span class="label">Paid:</span>
                                <span class="value">${{ "%.2f"|format(project.amount_paid) }}</span>
                            </div>
                            <div class="financial-item">
                                <span class="label">Remaining:</span>
                                <span class="value">${{ "%.2f"|format(project.total_amount - project.amount_paid) }}</span>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <div class="project-footer">
                    {% if project.is_subscription %}
                        <div class="subscription-actions">
                            {% if project.subscription_status in ['active', 'cancel_pending'] %}
                                {% if project.payment_method_type in ['manual', 'both'] %}
                                    <a href="{{ url_for('customers.manual_payment', project_id=project.id) }}" class="btn btn-primary btn-sm">Make Payment</a>
                                {% endif %}
                                <a href="{{ url_for('customers.manage_subscription', project_id=project.id) }}" class="btn btn-secondary btn-sm">Manage Subscription</a>
                                {% if project.project_type == 'ongoing_maintenance' and project.status == 'in_progress' %}
                                    <a href="{{ url_for('customers.request_feature', project_id=project.id) }}" class="btn btn-primary btn-sm feature-request-btn">✨ Request Feature</a>
                                {% endif %}
                            {% elif project.subscription_status == 'pending' %}
                                <div style="text-align:center; color:var(--text-muted); font-size:0.9rem;">
                                    <p>Payment pending admin confirmation.</p>
                                </div>
                            {% elif project.subscription_status == 'cancelled' %}
                                <div class="cancelled-subscription-info">
                                    <p style="margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem;">
                                        Would you like to resubscribe?
                                        <a href="mailto:shauna.saunders@alumni.unc.edu?subject=Resubscribe Request - {{ project.project_name }}&body=Hi Shauna,%0A%0AI would like to resubscribe to {{ project.project_name }}.%0A%0APlease let me know the next steps.%0A%0AThanks!"
                                           style="color: var(--primary-color); text-decoration: none;">
                                            Reach out here
                                        </a>
                                    </p>
                                </div>
                            {% else %}
                                <div class="payment-choice">
                                    {% if project.payment_method_type in ['stripe', 'both'] and project.stripe_price_id %}
                                    <form method="POST" action="{{ url_for('customers.create_checkout_session') }}" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="project_id" value="{{ project.id }}">
                                        <button type="submit" class="btn btn-primary btn-sm">Subscribe with Autopay</button>
                                    </form>
                                    {% endif %}
                                    {% if project.payment_method_type in ['manual', 'both'] %}
                                    <a href="{{ url_for('customers.manual_payment', project_id=project.id) }}" class="btn {% if project.payment_method_type == 'both' and project.stripe_price_id %}btn-secondary{% else %}btn-primary{% endif %} btn-sm">Pay via Venmo/CashApp/Zelle</a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="project-actions">
                            <a href="{{ url_for('customers.project_detail', project_id=project.id) }}" class="btn btn-secondary btn-sm">View Details</a>
                            {% if project.project_type == 'ongoing_maintenance' and project.status == 'in_progress' %}
                                <a href="{{ url_for('customers.request_feature', project_id=project.id) }}" class="btn btn-primary btn-sm feature-request-btn">✨ Request Feature</a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>You don't have any projects yet. Your project manager will create one for you soon!</p>
        </div>
        {% endif %}
    </section>

    {% if recent_payments %}
    <section class="section">
        <h2>Recent Payments</h2>

        <div class="payments-table-container">
            <table class="payments-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in recent_payments %}
                    <tr>
                        <td>{{ payment.created_at[:10] if payment.created_at else 'N/A' }}</td>
                        <td>${{ "%.2f"|format(payment.amount) }}</td>
                        <td><span class="payment-status status-{{ payment.status }}">{{ payment.status|title }}</span></td>
                        <td>{{ payment.description or 'Payment' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    {% endif %}
</div>

<style>
.agreement-warning-banner {
    background: var(--bg-dark, #1a1a2e);
    border: 2px solid #f59e0b;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.agreement-warning-banner .warning-icon {
    font-size: 2rem;
    color: #fbbf24;
    text-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
}

.agreement-warning-banner .warning-content {
    flex: 1;
    color: var(--text-color, #e0e0e0);
}

.agreement-warning-banner .warning-content strong {
    color: #fbbf24;
}

.agreement-warning-banner a {
    color: #fbbf24;
    font-weight: 600;
    text-decoration: underline;
    margin-left: 0.5rem;
}

.agreement-warning-banner a:hover {
    color: #fcd34d;
}

.project-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: center;
}

.subscription-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: center;
}

.feature-request-btn {
    background: linear-gradient(135deg, #10b981, #059669) !important;
    border: none !important;
    min-width: 160px !important;
    white-space: nowrap !important;
    padding: 0.5rem 1.25rem !important;
    transition: all 0.3s ease !important;
}

.feature-request-btn:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4) !important;
    color: white !important;
    text-decoration: none !important;
    background: linear-gradient(135deg, #059669, #047857) !important;
}

.payment-choice {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: center;
}

@media (max-width: 768px) {
    .project-actions, .subscription-actions, .payment-choice {
        flex-direction: column;
        gap: 0.5rem;
    }

    .project-actions .btn, .subscription-actions .btn, .payment-choice .btn {
        width: 100%;
        margin: 0;
    }
}
</style>
{% endblock %}

{% extends 'admin/base_admin.html' %}
{% block title %}Manage Subscription - {{ project.project_name }} - Admin{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('admin.projects') }}">Projects</a> /
    <a href="{{ url_for('admin.project_detail', project_id=project.id) }}">{{ project.project_name }}</a> /
    Subscription
</div>

<div class="page-header">
    <h1>Manage Subscription</h1>
    <a href="{{ url_for('admin.project_detail', project_id=project.id) }}" class="btn btn-secondary">Back to Project</a>
</div>

<div class="info-grid" style="margin-bottom:2rem;">
    <div><strong>Project:</strong> {{ project.project_name }}</div>
    <div><strong>Customer:</strong> <a href="{{ url_for('admin.customer_detail', customer_id=customer.id) }}">{{ customer.name }}</a> ({{ customer.email }})</div>
    <div><strong>Monthly Amount:</strong> ${{ "%.2f"|format(project.total_amount) }}</div>
    <div><strong>Payment Method:</strong>
        {% if project.payment_method_type == 'manual' %}
            <span class="badge" style="background:rgba(251, 191, 36, 0.2); color:#fbbf24;">Manual Only (Venmo/CashApp/Zelle)</span>
        {% elif project.payment_method_type == 'both' %}
            <span class="badge" style="background:rgba(103, 232, 249, 0.2); color:#67E8F9;">Both (Customer Chooses)</span>
        {% else %}
            <span class="badge" style="background:rgba(16, 185, 129, 0.2); color:#10b981;">Stripe Only (Autopay)</span>
        {% endif %}
    </div>
    <div><strong>Stripe Price ID:</strong> {{ project.stripe_price_id or 'Not set' }}</div>
</div>

<!-- Current Subscription Status -->
<div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; padding:1.5rem; margin-bottom:2rem;">
    <h2 style="margin-top:0; color:var(--admin-secondary);">Current Status</h2>
    <div class="info-grid">
        <div><strong>Subscription Status:</strong>
            <span class="badge badge-{{ project.subscription_status or 'inactive' }}">
                {{ (project.subscription_status or 'inactive')|replace('_', ' ')|title }}
            </span>
        </div>
        <div><strong>Stripe Subscription ID:</strong> {{ project.stripe_subscription_id or 'Not set' }}</div>
        <div><strong>Next Payment Date:</strong>
            {% if project.next_payment_date %}
                {{ project.next_payment_date[:10] if project.next_payment_date is string else project.next_payment_date.strftime('%Y-%m-%d') }}
            {% else %}
                Not set
            {% endif %}
        </div>
        {% if stripe_subscription %}
        <div><strong>Stripe Status:</strong>
            <span class="badge">{{ stripe_subscription.status }}</span>
        </div>
        {% endif %}
    </div>

    {% if project.stripe_subscription_id %}
    <form method="POST" style="margin-top:1rem;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="sync_from_stripe">
        <button type="submit" class="btn btn-secondary">Sync from Stripe</button>
    </form>
    {% endif %}
</div>

<!-- Manual Update Form -->
<div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; padding:1.5rem; margin-bottom:2rem;">
    <h2 style="margin-top:0; color:var(--admin-secondary);">Update Subscription Details</h2>
    <p style="color:var(--text-muted); margin-bottom:1.5rem;">Manually update local subscription records. Use this for customers who have been paying via other methods (Venmo, check, etc.).</p>

    <form method="POST" class="form-standard" style="max-width:100%;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="update_details">

        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1.5rem;">
            <div class="form-group" style="margin:0;">
                <label for="subscription_status">Subscription Status</label>
                <select id="subscription_status" name="subscription_status">
                    <option value="inactive" {% if project.subscription_status == 'inactive' or not project.subscription_status %}selected{% endif %}>Inactive</option>
                    <option value="active" {% if project.subscription_status == 'active' %}selected{% endif %}>Active</option>
                    <option value="cancel_pending" {% if project.subscription_status == 'cancel_pending' %}selected{% endif %}>Cancel Pending</option>
                    <option value="cancelled" {% if project.subscription_status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    <option value="past_due" {% if project.subscription_status == 'past_due' %}selected{% endif %}>Past Due</option>
                </select>
            </div>

            <div class="form-group" style="margin:0;">
                <label for="stripe_subscription_id">Stripe Subscription ID</label>
                <input type="text" id="stripe_subscription_id" name="stripe_subscription_id"
                       value="{{ project.stripe_subscription_id or '' }}"
                       placeholder="sub_1A2b3C4d5E6f7G8h">
                <small style="display:block; margin-top:0.25rem; color:var(--text-muted);">Leave blank if no Stripe subscription exists</small>
            </div>

            <div class="form-group" style="margin:0;">
                <label for="next_payment_date">Next Payment Date</label>
                <input type="date" id="next_payment_date" name="next_payment_date"
                       value="{% if project.next_payment_date %}{{ project.next_payment_date[:10] if project.next_payment_date is string else project.next_payment_date.strftime('%Y-%m-%d') }}{% endif %}">
            </div>
        </div>

        <div style="margin-top:1.5rem;">
            <button type="submit" class="btn btn-primary">Update Subscription Details</button>
        </div>
    </form>
</div>

<!-- Create Stripe Subscription -->
{% if project.stripe_price_id and not project.stripe_subscription_id %}
<div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; padding:1.5rem; margin-bottom:2rem;">
    <h2 style="margin-top:0; color:var(--admin-secondary);">Create Stripe Subscription</h2>
    <p style="color:var(--text-muted); margin-bottom:1.5rem;">
        Create a new Stripe subscription for this customer with a future first payment date.
        This is useful when a customer has already been paying you through other means (Venmo, check, etc.)
        and you want to transition them to Stripe billing without charging them immediately.
    </p>

    <form method="POST" class="form-standard" style="max-width:100%;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="create_stripe_subscription">

        <div class="form-group">
            <label for="first_payment_date">First Payment Date *</label>
            <input type="date" id="first_payment_date" name="first_payment_date" required>
            <small style="display:block; margin-top:0.5rem; color:var(--text-muted);">
                The customer will not be charged until this date. Stripe will create a subscription
                in "trialing" status until the first payment date. Must be at least 48 hours in the future.
            </small>
        </div>

        <div style="background:rgba(251, 191, 36, 0.15); border:1px solid var(--warning-color); border-radius:4px; padding:1rem; margin:1rem 0; color:var(--warning-color);">
            <strong>Note:</strong> This will create a real Stripe subscription using Price ID: <code>{{ project.stripe_price_id }}</code>
            <br>Customer: {{ customer.name }} ({{ customer.email }})
            <br>Amount: ${{ "%.2f"|format(project.total_amount) }}/month
        </div>

        <button type="submit" class="btn btn-primary">Create Stripe Subscription</button>
    </form>
</div>
{% elif not project.stripe_price_id %}
<div style="background:rgba(251, 191, 36, 0.15); border:1px solid var(--warning-color); border-radius:8px; padding:1.5rem; margin-bottom:2rem;">
    <h2 style="margin-top:0; color:var(--warning-color);">Create Stripe Subscription</h2>
    <p style="margin:0; color:var(--text-light);">
        <strong>Stripe Price ID Required:</strong> To create a Stripe subscription, you must first
        <a href="{{ url_for('admin.edit_project', project_id=project.id) }}" style="color:var(--admin-secondary);">edit this project</a>
        and add a Stripe Price ID. Create a recurring price in your
        <a href="https://dashboard.stripe.com/products" target="_blank" rel="noopener" style="color:var(--admin-secondary);">Stripe Dashboard</a> first.
    </p>
</div>
{% elif project.stripe_subscription_id %}
<div style="background:rgba(16, 185, 129, 0.15); border:1px solid var(--admin-secondary); border-radius:8px; padding:1.5rem; margin-bottom:2rem;">
    <h2 style="margin-top:0; color:var(--admin-secondary);">Stripe Subscription Active</h2>
    <p style="margin:0; color:var(--text-light);">
        This project already has a Stripe subscription: <code>{{ project.stripe_subscription_id }}</code>
        <br><br>
        <a href="https://dashboard.stripe.com/subscriptions/{{ project.stripe_subscription_id }}"
           target="_blank" rel="noopener" class="btn btn-secondary">View in Stripe Dashboard</a>
    </p>
</div>
{% endif %}

<!-- Record Manual Payment -->
<div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; padding:1.5rem; margin-bottom:2rem;">
    <h2 style="margin-top:0; color:var(--admin-secondary);">Record Manual Payment</h2>
    <p style="color:var(--text-muted); margin-bottom:1.5rem;">
        Record a payment received via Venmo, CashApp, or Zelle.
        {% if project.payment_method_type == 'manual' %}
        <br><strong>Payment info:</strong> Venmo: @shaunacs | CashApp: $shaunacs14 | Zelle: shauna.saunders@yahoo.com
        {% endif %}
    </p>

    <form method="POST" class="form-standard" style="max-width:100%;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="record_manual_payment">

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem;">
            <div class="form-group" style="margin:0;">
                <label for="payment_amount">Payment Amount *</label>
                <input type="number" id="payment_amount" name="payment_amount" step="0.01" min="0" required
                       value="{{ "%.2f"|format(project.total_amount) }}">
            </div>

            <div class="form-group" style="margin:0;">
                <label for="payment_method">Payment Method *</label>
                <select id="payment_method" name="payment_method" required>
                    <option value="">Select method...</option>
                    <option value="venmo">Venmo (@shaunacs)</option>
                    <option value="cashapp">CashApp ($shaunacs14)</option>
                    <option value="zelle">Zelle (shauna.saunders@yahoo.com)</option>
                </select>
            </div>

            <div class="form-group" style="margin:0;">
                <label for="payment_date">Payment Date</label>
                <input type="date" id="payment_date" name="payment_date" value="{{ now.strftime('%Y-%m-%d') }}">
            </div>

            <div class="form-group" style="margin:0;">
                <label for="next_payment_date_manual">Next Payment Date</label>
                <input type="date" id="next_payment_date_manual" name="next_payment_date_manual">
                <small style="display:block; margin-top:0.25rem; color:var(--text-muted);">Update when the next payment is due</small>
            </div>
        </div>

        <div class="form-group" style="margin-top:1rem;">
            <label for="payment_notes">Notes</label>
            <input type="text" id="payment_notes" name="payment_notes" placeholder="Optional notes about this payment">
        </div>

        <div style="margin-top:1rem;">
            <button type="submit" class="btn btn-primary">Record Payment</button>
        </div>
    </form>
</div>

<!-- Switch Payment Method -->
<div style="background:var(--bg-card); border:1px solid var(--border-color); border-radius:8px; padding:1.5rem; margin-bottom:2rem;">
    <h2 style="margin-top:0; color:var(--admin-secondary);">Switch Payment Method</h2>
    <p style="color:var(--text-muted); margin-bottom:1.5rem;">
        Current method: <strong>
        {% if project.payment_method_type == 'manual' %}Manual Only (Venmo/CashApp/Zelle)
        {% elif project.payment_method_type == 'both' %}Both (Customer Chooses)
        {% else %}Stripe Only (Autopay){% endif %}</strong>
    </p>

    <form method="POST" class="form-standard" style="max-width:100%;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="switch_payment_method">

        <div class="form-group" style="margin-bottom:1rem;">
            <label for="new_payment_method_type"><strong>Switch to:</strong></label>
            <select name="new_payment_method_type" id="new_payment_method_type" style="margin-top:0.5rem;">
                <option value="both" {% if project.payment_method_type == 'both' %}disabled{% endif %}>Both (Customer Chooses)</option>
                <option value="stripe" {% if project.payment_method_type == 'stripe' %}disabled{% endif %}>Stripe Only (Autopay)</option>
                <option value="manual" {% if project.payment_method_type == 'manual' %}disabled{% endif %}>Manual Only (Venmo/CashApp/Zelle)</option>
            </select>
        </div>

        <div style="background:rgba(103, 232, 249, 0.15); border:1px solid rgba(103, 232, 249, 0.3); border-radius:4px; padding:1rem; margin-bottom:1rem; color:#67E8F9;">
            <strong>Stripe/Both:</strong> Requires a Stripe Price ID on the project.<br>
            <strong>Manual:</strong> Customer pays via Venmo, CashApp, or Zelle. You record payments manually.<br>
            <strong>Both:</strong> Customer can choose either option from their dashboard.
        </div>

        <button type="submit" class="btn btn-secondary">Switch Payment Method</button>
    </form>
</div>
{% endblock %}

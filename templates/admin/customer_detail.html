{% extends 'admin/base_admin.html' %}
{% block title %}{{ customer.name }} - Admin{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('admin.customers') }}">Customers</a> / {{ customer.name }}
</div>

<div class="page-header">
    <h1>{{ customer.name }}</h1>
    <div>
        <a href="{{ url_for('admin.edit_customer', customer_id=customer.id) }}" class="btn btn-secondary">Edit Customer</a>
        <form method="POST" action="{{ url_for('admin.toggle_customer_active', customer_id=customer.id) }}" style="display:inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-secondary">
                {% if customer.is_active %}Deactivate{% else %}Activate{% endif %}
            </button>
        </form>
        <form method="POST" action="{{ url_for('admin.delete_customer_route', customer_id=customer.id) }}" style="display:inline" data-confirm="Are you sure you want to delete this customer? This cannot be undone.">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-secondary" style="background:#E74C3C">Delete</button>
        </form>
    </div>
</div>

<div class="info-grid">
    <div><strong>Email:</strong> {{ customer.email }}</div>
    <div><strong>Company:</strong> {{ customer.company or '-' }}</div>
    <div><strong>Phone:</strong> {{ customer.phone or '-' }}</div>
    <div><strong>Status:</strong> <span class="badge badge-{% if customer.is_active %}success{% else %}inactive{% endif %}">{% if customer.is_active %}Active{% else %}Inactive{% endif %}</span></div>
    <div><strong>Total Paid:</strong> ${{ "%.2f"|format(total_paid) }}</div>
    <div><strong>Outstanding:</strong> ${{ "%.2f"|format(outstanding) }}</div>
</div>

<h2>Projects</h2>
{% if projects %}
<table class="data-table">
    <thead>
        <tr>
            <th>Project Name</th>
            <th>Type</th>
            <th>Status</th>
            <th>Total</th>
            <th>Paid</th>
            <th>Remaining</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for project in projects %}
        <tr>
            <td>{{ project.project_name }}</td>
            <td>{{ project.project_type|replace('_', ' ')|title }}</td>
            <td><span class="badge badge-{{ project.status }}">{{ project.status|title }}</span></td>
            <td>${{ "%.2f"|format(project.total_amount) }}</td>
            <td>${{ "%.2f"|format(project.amount_paid) }}</td>
            <td>${{ "%.2f"|format(project.total_amount - project.amount_paid) }}</td>
            <td><a href="{{ url_for('admin.project_detail', project_id=project.id) }}" class="btn btn-sm">View</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="empty-state">No projects yet. <a href="{{ url_for('admin.create_project_route') }}?customer_id={{ customer.id }}">Create a project</a></p>
{% endif %}

<div class="actions-section">
    <h2>Quick Actions</h2>
    <div style="display:flex; gap:1rem;">
        <a href="{{ url_for('admin.create_project_route') }}?customer_id={{ customer.id }}" class="btn btn-primary">Create Project</a>
        <a href="{{ url_for('admin.create_payment_link') }}?customer_id={{ customer.id }}" class="btn btn-primary">Generate Payment Link</a>
    </div>
</div>

{% if payment_links %}
<h2>Payment Links</h2>
<table class="data-table">
    <thead>
        <tr>
            <th>Amount</th>
            <th>Description</th>
            <th>Created</th>
            <th>Expires</th>
            <th>Used</th>
            <th>Link</th>
        </tr>
    </thead>
    <tbody>
        {% for link in payment_links %}
        <tr>
            <td>${{ "%.2f"|format(link.amount) }}</td>
            <td>{{ link.description or '-' }}</td>
            <td>{{ link.created_at[:10] if link.created_at else '-' }}</td>
            <td>{{ link.expires_at[:10] if link.expires_at else '-' }}</td>
            <td><span class="badge badge-{% if link.used %}success{% else %}pending{% endif %}">{% if link.used %}Yes{% else %}No{% endif %}</span></td>
            <td>{% if not link.used %}<a href="{{ link.stripe_checkout_url }}" target="_blank">Open</a>{% else %}-{% endif %}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{% if payments %}
<h2>Payment History</h2>
<table class="data-table">
    <thead>
        <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Project</th>
            <th>Status</th>
            <th>Method</th>
        </tr>
    </thead>
    <tbody>
        {% for payment in payments %}
        <tr>
            <td>{{ payment.created_at[:10] if payment.created_at else '-' }}</td>
            <td>${{ "%.2f"|format(payment.amount) }}</td>
            <td>{{ payment.project_id or '-' }}</td>
            <td><span class="badge badge-{{ payment.status }}">{{ payment.status|title }}</span></td>
            <td>{{ payment.payment_method or '-' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}
{% endblock %}

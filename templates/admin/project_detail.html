{% extends 'admin/base_admin.html' %}
{% block title %}{{ project.project_name }} - Admin{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('admin.projects') }}">Projects</a> / {{ project.project_name }}
</div>

<div class="page-header">
    <h1>{{ project.project_name }}</h1>
    <div>
        <a href="{{ url_for('admin.edit_project', project_id=project.id) }}" class="btn btn-secondary">Edit Project</a>
        <form method="POST" action="{{ url_for('admin.delete_project_route', project_id=project.id) }}" style="display:inline" data-confirm="Are you sure you want to delete this project?">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-secondary" style="background:#E74C3C">Delete</button>
        </form>
    </div>
</div>

<div class="info-grid">
    <div><strong>Customer:</strong> <a href="{{ url_for('admin.customer_detail', customer_id=customer.id) }}">{{ customer.name }}</a></div>
    <div><strong>Type:</strong> {{ project.project_type|replace('_', ' ')|title }}</div>
    <div><strong>Status:</strong> <span class="badge badge-{{ project.status }}">{{ project.status|title }}</span></div>
    <div><strong>Payment Plan:</strong> {{ project.payment_plan|replace('_', ' ')|title if project.payment_plan else '-' }}</div>
    <div><strong>Total Amount:</strong> ${{ "%.2f"|format(project.total_amount) }}{% if project.is_subscription %}/month{% endif %}</div>
    <div><strong>Amount Paid:</strong> ${{ "%.2f"|format(project.amount_paid) }}</div>
    <div><strong>Remaining:</strong> ${{ "%.2f"|format(project.total_amount - project.amount_paid) }}</div>
    <div><strong>Completion:</strong> {{ completion_percentage }}%</div>
    <div><strong>Project Email:</strong> {{ project.email if project.email else '(uses customer email)' }}</div>
</div>

{% if project.is_subscription %}
<div style="margin:2rem 0; padding:1.5rem; background:#e8f4fd; border:1px solid #b8daff; border-radius:8px;">
    <div style="display:flex; justify-content:space-between; align-items:start; flex-wrap:wrap; gap:1rem;">
        <div>
            <h3 style="margin:0 0 0.5rem 0;">Subscription Details</h3>
            <div class="info-grid" style="margin:0;">
                <div><strong>Subscription Status:</strong>
                    <span class="badge badge-{{ project.subscription_status or 'inactive' }}">
                        {{ (project.subscription_status or 'inactive')|replace('_', ' ')|title }}
                    </span>
                </div>
                <div><strong>Stripe Price ID:</strong> {{ project.stripe_price_id or 'Not set' }}</div>
                <div><strong>Stripe Subscription ID:</strong> {{ project.stripe_subscription_id or 'Not set' }}</div>
                <div><strong>Next Payment:</strong>
                    {% if project.next_payment_date %}
                        {{ project.next_payment_date[:10] if project.next_payment_date is string else project.next_payment_date.strftime('%Y-%m-%d') }}
                    {% else %}
                        Not set
                    {% endif %}
                </div>
            </div>
        </div>
        <div>
            <a href="{{ url_for('admin.manage_subscription', project_id=project.id) }}" class="btn btn-primary">Manage Subscription</a>
        </div>
    </div>
</div>
{% endif %}

{% if project.description %}
<div style="margin:2rem 0; padding:1.5rem; background:var(--background-color); border-radius:8px;">
    <strong>Description:</strong>
    <p>{{ project.description }}</p>
</div>
{% endif %}

<h2>Milestones</h2>

<form method="POST" action="{{ url_for('admin.create_milestone_route', project_id=project.id) }}" class="form-standard" style="max-width:100%; margin-bottom:2rem;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <h3>Add Milestone</h3>
    <div style="display:grid; grid-template-columns:1fr 2fr 1fr 1fr auto; gap:1rem; align-items:end;">
        <div class="form-group" style="margin:0;">
            <label>Milestone Name *</label>
            <input type="text" name="milestone_name" required>
        </div>
        <div class="form-group" style="margin:0;">
            <label>Description</label>
            <input type="text" name="description">
        </div>
        <div class="form-group" style="margin:0;">
            <label>
                <input type="checkbox" name="is_payment_milestone"> Payment Milestone
            </label>
        </div>
        <div class="form-group" style="margin:0;">
            <label>Amount</label>
            <input type="number" name="payment_amount" step="0.01" placeholder="0.00">
        </div>
        <button type="submit" class="btn btn-primary">Add</button>
    </div>
</form>

{% if milestones %}
<table class="data-table">
    <thead>
        <tr>
            <th>Milestone</th>
            <th>Description</th>
            <th>Status</th>
            <th>Payment Milestone</th>
            <th>Amount</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for milestone in milestones %}
        <tr>
            <td>{{ milestone.milestone_name }}</td>
            <td>{{ milestone.description or '-' }}</td>
            <td><span class="badge badge-{{ milestone.status }}">{{ milestone.status|title }}</span></td>
            <td>{% if milestone.is_payment_milestone %}Yes{% else %}No{% endif %}</td>
            <td>{% if milestone.payment_amount %}${{ "%.2f"|format(milestone.payment_amount) }}{% else %}-{% endif %}</td>
            <td>
                {% if milestone.status != 'completed' %}
                <form method="POST" action="{{ url_for('admin.complete_milestone', milestone_id=milestone.id) }}" style="display:inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm">Complete</button>
                </form>
                {% endif %}
                <form method="POST" action="{{ url_for('admin.delete_milestone_route', milestone_id=milestone.id) }}" style="display:inline" data-confirm="Delete this milestone?">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm" style="background:#E74C3C">Delete</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="empty-state">No milestones yet. Add one above.</p>
{% endif %}

{% if payments %}
<h2>Payment History</h2>
<table class="data-table">
    <thead>
        <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Method</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        {% for payment in payments %}
        <tr>
            <td>{{ payment.created_at[:10] if payment.created_at else '-' }}</td>
            <td>${{ "%.2f"|format(payment.amount) }}</td>
            <td><span class="badge badge-{{ payment.status }}">{{ payment.status|title }}</span></td>
            <td>{{ payment.payment_method or '-' }}</td>
            <td>{{ payment.description or '-' }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<h2>Service Agreement</h2>
{% if agreement %}
<div class="agreement-status-card" style="background:#f8f9fa; border:1px solid #dee2e6; border-radius:8px; padding:1.5rem; margin-bottom:1rem;">
    <div style="display:flex; justify-content:space-between; align-items:start; flex-wrap:wrap; gap:1rem;">
        <div>
            <h3 style="margin:0 0 0.5rem 0;">{{ agreement.title }}</h3>
            <p style="color:#6b7280; margin:0;">
                Version {{ agreement.version }} |
                {{ agreement.agreement_type|replace('_', ' ')|title }} |
                Created {{ agreement.created_at[:10] if agreement.created_at else 'N/A' }}
            </p>
            {% if agreement_signature %}
            <p style="color:#10b981; margin:0.5rem 0 0 0;">
                <strong>Signed:</strong> {{ agreement_signature.signed_at[:10] if agreement_signature.signed_at else 'N/A' }} by {{ agreement_signature.signature_name }}
            </p>
            {% else %}
            <p style="color:#f59e0b; margin:0.5rem 0 0 0;">
                <strong>Status:</strong> Awaiting customer signature
            </p>
            {% endif %}
        </div>
        <div>
            <a href="{{ url_for('admin.agreement_detail', agreement_id=agreement.id) }}" class="btn btn-secondary">View Agreement</a>
            <a href="{{ url_for('admin.edit_agreement', agreement_id=agreement.id) }}" class="btn btn-secondary">Edit / New Version</a>
        </div>
    </div>
</div>
{% else %}
<div class="empty-state" style="text-align:center; padding:2rem; background:#f8f9fa; border-radius:8px;">
    <p>No agreement has been created for this project yet.</p>
    <a href="{{ url_for('admin.create_agreement_for_project', project_id=project.id) }}" class="btn btn-primary">Create Agreement</a>
</div>
{% endif %}
{% endblock %}
